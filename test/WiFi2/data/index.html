<!DOCTYPE HTML><html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/highcharts.js"></script>

  <style>
    * { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif }
    body { min-width: 310px; max-width: 800px; height: 400px; margin: 0 auto; }
    h2 { font-family: Impact, Haettenschweiler; font-size: 2.5rem; text-align: center; }
    .boundText { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-style: italic;}
    .progressBar { width: 100%; background-color: lightgrey; display: inline-block;}
    .tempBar { width: 10%; height: 20px; background-color: #04AA6D; text-align: center; line-height: 20px; color: white; transition: width .5s;}
  </style>
</head>

<body>
  <h2>Weather Station</h2>
    Current Temperature: <span id="currentTemp">Lorem Ipsum</span> <br><br>
    <div class="progressBar"><div id="currentTempBar" class="tempBar"></div></div>
      <br><br>
    Average Temperature: <span id="avgTemp">Lorem Ipsum</span> <br><br>
    <div class="progressBar"><div id="avgTempBar" class="tempBar"></div></div>

    <div id="chart-temperature" class="container"></div>

</body>

<script>
  function mapScales(originMin, originMax, val, targetMin, targetMax) {
      return (((val - originMin) / (originMax - originMin)) * (targetMax - targetMin)) + targetMin;
  }

  var max_temp = 60;
  var min_temp = -15;

  function clampTemp(temp){
      if (temp > max_temp) temp = max_temp;
      else if (temp < min_temp) temp = min_temp;
      return temp;
  }

  function tempToGradientIndex(temp){
      return Math.round(mapScales(min_temp, max_temp, clampTemp(temp), 0, 15));
  }

  function roundTo2dp(num){
      return Math.round(num * 100) / 100;
  }

  var colors = ["#5053fd", "#5474fc", "#598ffd", "#61a9fe", "#63c5ff",
      "#6ae2fe", "#7fe5d7", "#8be8b8", "#a1ec91", "#b6ed68",
      "#c3ee4d", "#d1dd3d", "#dbbd3f", "#e39b44", "#ec7946", "#f5504c"];
</script>

<script>
  var currentTemperature = 45;
  var avgTemperature = 20;

  function setTemp(temp, tempName) {
    var elem = document.getElementById(tempName + "Bar");
    
    var upperBound = Math.ceil(temp / 10) * 10;
    var lowerBound = Math.floor(temp / 10) * 10;

    temp = roundTo2dp(temp);

    if (upperBound === lowerBound) lowerBound = upperBound - 10;

    var width = mapScales(lowerBound, upperBound, temp, 1, 100);

    elem.style.width = width + "%";
    elem.innerText = temp + " C";
    elem.style.background = colors[tempToGradientIndex(temp)];

    document.getElementById(tempName).innerText = temp + "C";
  }
 
  var counter = 0;
  var flag = true;

  var id = setInterval(frame, 1000);
  function frame() {
    if (++counter >= 17) {
        flag = !flag;
        counter = 0;
    }

    if (flag) currentTemperature += counter/5;
    else currentTemperature -= (16 - counter)/5;

    currentTemperature = clampTemp(currentTemperature);
    avgTemperature = 75 - currentTemperature;

    setTemp(currentTemperature, "currentTemp");
    setTemp(avgTemperature, "avgTemp");
  }

  setTemp(currentTemperature, "currentTemp");
  setTemp(avgTemperature, "avgTemp");
</script>

<script>
  var chartT = new Highcharts.Chart({
    chart:{ renderTo : 'chart-temperature' },
    title: { text: 'Temperature' },
    series: [{ showInLegend: false, data: [] }],
    plotOptions: { line: { animation: false, dataLabels: { enabled: true } },
      series: { color: '#059e8a' } },
    xAxis: { type: 'datetime', dateTimeLabelFormats: { second: '%H:%M:%S' }
    },
    yAxis: {
      title: { text: 'Temperature (Celsius)' }
    },
    credits: { enabled: false }
  });

  setInterval(function ( ) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var x = (new Date()).getTime(),
            y = parseFloat(this.responseText);

        currentTemperature = y;

        if(chartT.series[0].data.length > 40) {
          chartT.series[0].addPoint([x, y], true, true, true);
        } else {
          chartT.series[0].addPoint([x, y], true, false, true);
        }
      }
    };
    xhttp.open("GET", "/temperature", true);
    xhttp.send();
  }, 1000 ) ;

  setInterval(function ( ) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        avgTemperature = parseFloat(this.responseText);
      }
    };
    xhttp.open("GET", "/avg_temperature", true);
    xhttp.send();
  }, 1000 ) ;
</script>
</html>